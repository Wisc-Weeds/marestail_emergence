---
title: "Marestail emergence in Nebraska"
author: "Maxwel Coura Oliveira"
date: "6/24/2021"
output: html_document
---


```{r}
library(tidyverse)
library(drc)
library(reactable)
library(ggthemes)
library(ggtext)
library(patchwork)
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "SCOTTSBLUFF") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(1:4) %>% 
  pivot_longer(cols = 2:4, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2016 - Apr 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("population", "type"), sep = "-") %>% 
  mutate_at(c("population", "type"), str_squish) %>% 
  mutate(population = fct_recode(population,
                                 "Lin1" = "Lincoln",
                                 "Npl1" = "North Platte",
                                 "Scb1" = "Scottsbluff")) %>% 
  mutate(location = "Scottsbluff") %>% 
  filter(!is.na(GDD))
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "SCOTTSBLUFF") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(7:13) %>% 
  pivot_longer(cols = 2:7, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2017 - Dec 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("population", "type"), sep = "-") %>% 
  mutate_at(c("population", "type"), str_squish) %>% 
  mutate(population = fct_recode(population,
                                 "Lin1" = "Lincoln",
                                 "Npl1" = "North Platte",
                                 "Scb1" = "Scottsbluff")) %>% 
  mutate(location = "Scottsbluff")
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "Lincoln") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(1:9) %>% 
  pivot_longer(cols = 2:9, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2016 - Apr 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("population", "type"), sep = "-") %>% 
  mutate_at(c("population", "type"), str_squish) %>% 
  mutate(population = fct_recode(population,
                                 "Lin1" = "Lincoln",
                                 "Npl1" = "North Platte",
                                 "Scb1" = "Scottsbluff")) %>% 
  mutate(location = "Lincoln") %>% 
  filter(!is.na(GDD))
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "Lincoln") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(13:21) %>% 
  pivot_longer(cols = 2:9, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2017-Jun 2018") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("population", "type"), sep = "-") %>% 
  mutate_at(c("population", "type"), str_squish) %>% 
  mutate(population = fct_recode(population,
                                 "Lin1" = "Lincoln",
                                 "Npl1" = "North Platte",
                                 "Scb1" = "Scottsbluff")) %>% 
  mutate(location = "Lincoln") %>% 
  filter(!is.na(GDD))
```




```{r}
readxl::read_excel("Emergence.xlsx", sheet = "North Platte") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(1:4) %>% 
  pivot_longer(cols = 2:4, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2016 - May 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("population", "type"), sep = "-") %>% 
  mutate_at(c("population", "type"), str_squish) %>% 
  mutate(population = fct_recode(population,
                                 "Lin1" = "Lincoln",
                                 "Npl1" = "North Platte",
                                 "Scb1" = "Scottsbluff")) %>% 
  mutate(location = "North Platte") %>% 
  filter(!is.na(GDD)) -> np1
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "North Platte") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(5:8) %>% 
  pivot_longer(cols = 2:4, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2016 - May 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("population", "type"), sep = "-") %>% 
  mutate_at(c("population", "type"), str_squish) %>% 
  mutate(population = fct_recode(population,
                                 "Lin1" = "Lincoln",
                                 "Npl1" = "North Platte",
                                 "Scb1" = "Scottsbluff")) %>% 
  mutate(location = "North Platte") %>% 
  filter(!is.na(GDD)) -> np2
```



```{r}
np1 %>% 
  bind_rows(np2) %>% 
  mutate(type = str_to_lower(type)) %>% 
  unite("trt", c("population", "type"), sep = " in ", remove = FALSE) %>% 
  drop_na() -> north_platte
```




```{r message = FALSE, warning = FALSE}
model3 <- drm(emergence ~ GDD, trt, 
              fct = W1.3(fixed = c(NA, 100, NA), 
                         names = c("slope", "upper", "ed50")),
              data = north_platte)
```

```{r}
plot(model3)
```


```{r}
broom::tidy(model3) %>% 
  mutate_if(is.double, ~ round(., 2)) %>% 
  reactable()
```

  
```{r}
ED(model3, c(10, 50, 90), type = "absolute", interval = "delta") %>% 
  as.data.frame() %>% 
  rownames_to_column(., var = "name") %>% 
  as_tibble() %>% 
  separate(name, c("param", "trt", "ED"), sep = ":") %>% 
  janitor::clean_names() %>% 
  separate("trt", c("population", "type"), sep = " in ", remove = FALSE) %>% 
#  mutate(location = str_to_title(location)) %>% 
  mutate_if(is_character, as_factor) -> ed3
```

```{r}
EDcomp(model3, c(90,90), type = "absolute", 
       interval = "delta", level = 0.95)
```


```{r}
ed3 %>% 
  mutate(ed = case_when(
  ed == "10" ~ "10% emergence",
  ed == "50" ~ "50% emergence",
  ed == "90" ~ "90% emergence",
  TRUE ~ "ed")) %>% 
  ggplot(aes(x = population, y = estimate, color = type)) +
  geom_point(position = position_dodge(width = 0.7)) +
  geom_linerange(aes(ymin = lower, ymax = upper), 
                 position = position_dodge(width = 0.7)) +
  labs(x = NULL, y = "Growing degree days"#,
#       title = "Horseweed emergence in <b style='color:#0000ff;'>wheat stubble</b> and <b style='color:#b02631;'>soybean</b> at North Platte, NE",
#       subtitle = "Horseweed accessions comulative emergence was recorded from Sep 2016 to May 2017"
) +
  scale_color_manual(values = c("#b02631", "#0000ff")) +
  facet_grid(~ ed, switch = "y") +
  coord_flip() +
  theme_few() +
  scale_y_continuous(limits = c(0, 1500)) +
  theme(legend.position = "none",
        plot.title.position = "plot",
        plot.title = element_markdown(),
        plot.subtitle = element_markdown(size = 10)) -> fig3

ggsave("figures/fig_3.png", dpi = 300)
```




```{r Control prediction, include=FALSE}
newdata <- expand.grid(GDD=exp(seq(log(0.5), log(1500), length=1500)))
newdata1 <- data.frame(trt =c("Lin1 in soybean"), newdata)
newdata2 <- data.frame(trt =c("Lin1 in wheat stubble"), newdata)
newdata3 <- data.frame(trt =c("Npl1 in soybean"), newdata)
newdata4 <- data.frame(trt =c("Npl1 in wheat stubble"), newdata)
newdata5 <- data.frame(trt =c("Scb1 in soybean"), newdata)
newdata6 <- data.frame(trt =c("Scb1 in wheat stubble"), newdata)

nd=rbind(newdata1, newdata2, newdata3, newdata4, newdata5, newdata6)

pm <- predict(model3, newdata=nd, interval="confidence")

nd$p <- pm[,1] 
nd$pmin <- pm[,2] 
nd$pmax <- pm[,3] 

north_platte$GDD0 <- north_platte$GDD
north_platte$GDD0[north_platte$GDD0==0] <- 0.5
```

```{r}
ed3 
```

```{r Control Plot, message=FALSE, warning=FALSE}
north_platte %>% 
ggplot(aes(x = GDD, y = emergence, color = trt)) + 
  geom_line(data = nd, aes(x = GDD, y = p, color = trt), size = 1.2) +
  labs(y="Cumulative emergence (%)", x = "Growing degree days") +
#  coord_trans(x= "log") +
  geom_jitter(data = north_platte, aes(x = GDD, y = emergence, color = trt),
              alpha = 0.1) +
#  scale_color_brewer(name = NULL, palette = "Set1") +
  scale_color_viridis_d(name = NULL, option = "C") +
  geom_segment(aes(x = 0.5, y = 10, 
                   xend = 200, yend = 10), 
               arrow = arrow(length = unit(0.03, "npc")), 
               size = 1.05,
               color = "blue") +
  annotate("text", x = 350, y = 10, label = "10% emergence", fontface = 'italic') +
  geom_segment(aes(x = 50, y = 50, 
                   xend = 400, yend = 50), 
               arrow = arrow(length = unit(0.03, "npc")),
               size = 1.05,
               color = "blue") +
  annotate("text", x = 560, y = 50, label = "50% emergence", fontface = 'italic') +
  geom_segment(aes(x = 350, y = 90, 
                   xend = 1450, yend = 90), 
               arrow = arrow(length = unit(0.03, "npc")),
               size = 1.05,
               color = "blue") +
  annotate("text", x = 1450, y = 82, label = "90% \nemergence", fontface = 'italic') +
  theme_few() +
  theme(legend.position = c(0.85, 0.22)) -> fig4

ggsave("figures/fig4.png")
```


```{r}
readxl::read_excel("Scottsbluff Marestail.xlsx", sheet = "Weather Yr1") %>% 
  janitor::row_to_names(row_number = 2) %>% 
  janitor::clean_names() %>% 
  rename(
    temp_high = c,
    temp_low = c_2,
    rel_hum = percent,
    precip = mm,
    wind_sp = m_s,
    soil_temp = c_10cm
  ) %>% 
  dplyr::select(-mj_m_2, -mm_2, -time) %>% 
  unite("date", c("year", "month", "day"), sep = "-") %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  mutate_if(is_character, as.double) -> wd_sct1

readxl::read_excel("Scottsbluff Marestail.xlsx", sheet = "Weather Yr2") %>% 
  janitor::row_to_names(row_number = 2) %>% 
  janitor::clean_names() %>% 
  rename(
    temp_high = c,
    temp_low = c_2,
    rel_hum = percent,
    precip = mm,
    wind_sp = m_s,
    soil_temp = c_10cm
  ) %>% 
  dplyr::select(-mj_m_2, -mm_2, -time) %>% 
  unite("date", c("year", "month", "day"), sep = "-") %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  mutate_if(is_character, as.double) -> wd_sct2


wd_sct1 %>% 
  bind_rows(wd_sct2) %>% 
  mutate(mean_temp = (temp_high + temp_low) / 2) %>% 
  pivot_longer(cols = c("mean_temp", "soil_temp"), 
               names_to = "type", values_to = "temp") -> wd_sct
```

```{r}
ylim.prim <- c(0, 180)   # in this example, precipitation
ylim.sec <- c(-27, 36)    # in this example, temperature

b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1] # there was a bug here
```


```{r}
wd_sct %>% 
  mutate(type = fct_recode(type,
                           "Air temperature (C)" = "mean_temp",
                           "Soil temperature (C)" = "soil_temp")) %>% 
  ggplot(aes(x = date, y = a + temp*b)) +
  geom_point(aes(color = type), size = 1, alpha = 0.5) +
  geom_line(aes(color = type, linetype = type), size = .3) +
  scale_color_manual(name = NULL, values = c("blue", "firebrick")) +
  scale_shape_manual(name = NULL, values = c(18, 16)) +
  scale_linetype_manual(name = NULL, values = c(3, 1)) +
  scale_y_continuous(
    "Precipitation (mm)", 
    sec.axis = sec_axis(~ (. - a)/b, name = "Temperature (C)")) +
  scale_x_date(date_minor_breaks = "1 day", date_labels = "%b %Y") +
  theme_bw() +
  theme(legend.position = "bottom") +
  geom_bar(aes(x = date, y = precip, 
               width = 3,
               linetype = NULL, 
               shape = NULL), 
           stat = "identity", 
           fill = "grey10",
           show.legend = FALSE) +
  labs(x = NULL) -> temp

ggsave("figures/temp.png")
```

```{r}
temp + fig4 -> figg

fig_np <- figg / fig3 +
  plot_annotation(title = "Horseweed emergence in <b style='color:#0000ff;'>wheat stubble</b> and <b style='color:#b02631;'>soybean</b> at North Platte, NE",
       subtitle = "Horseweed accessions comulative emergence was recorded from Sep 2016 to May 2017") 

ggsave(x = fig_np, filename = "figures/north_platte.png")
```

