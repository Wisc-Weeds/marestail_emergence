---
title: "Marestail emergence in Nebraska"
author: "Maxwel Coura Oliveira"
date: "6/24/2021"
output: html_document
---


```{r}
library(tidyverse)
library(drc)
library(reactable)
library(ggthemes)
library(ggtext)
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "SCOTTSBLUFF") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(1:4) %>% 
  pivot_longer(cols = 2:4, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2016 - Apr 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("location", "type"), sep = "-") %>% 
  mutate_at(c("location", "type"), str_squish) 
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "SCOTTSBLUFF") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(7:13) %>% 
  pivot_longer(cols = 2:7, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2017 - Dec 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("location", "type"), sep = "-") %>% 
  mutate_at(c("location", "type"), str_squish) 
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "Lincoln") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(1:9) %>% 
  pivot_longer(cols = 2:9, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2016 - Apr 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("location", "type"), sep = "-") %>% 
  mutate_at(c("location", "type"), str_squish) 
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "Lincoln") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(13:21) %>% 
  pivot_longer(cols = 2:9, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2017-Jun 2018") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("location", "type"), sep = "-") %>% 
  mutate_at(c("location", "type"), str_squish) 
```




```{r}
readxl::read_excel("Emergence.xlsx", sheet = "North Platte") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(1:4) %>% 
  pivot_longer(cols = 2:4, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2016 - May 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("location", "type"), sep = "-") %>% 
  mutate(type = str_to_lower(type)) %>% 
  mutate_at(c("location", "type"), str_squish) -> wheat
```


```{r}
readxl::read_excel("Emergence.xlsx", sheet = "North Platte") %>% 
  janitor::row_to_names(row_number = 1) %>% 
  dplyr::select(5:8) %>% 
  pivot_longer(cols = 2:4, names_to = "type", values_to = "emergence") %>% 
  mutate(date = "Sep 2016 - May 2017") %>% 
  mutate_at(c("GDD", "emergence"),  as.double) %>% 
  mutate_at(c("GDD", "emergence"), ~ round(., 2)) %>% 
  separate("type", c("location", "type"), sep = "-") %>% 
  mutate_at(c("location", "type"), str_squish) -> soy
```


```{r}
soy %>% 
  bind_rows(wheat) %>% 
  unite("trt", c("location", "type"), sep = " - ") %>% 
  drop_na() -> north_platte
```




```{r message = FALSE, warning = FALSE}
model3 <- drm(emergence ~ GDD, trt, 
              fct = W1.3(fixed = c(NA, 100, NA), 
                         names = c("slope", "upper", "ed50")),
              data = north_platte)
```

```{r}
plot(model3)
```


```{r}
broom::tidy(model3) %>% 
  mutate_if(is.double, ~ round(., 2)) %>% 
  reactable()
```

  
```{r}
ED(model3, c(10, 50, 90), type = "absolute", interval = "delta") %>% 
  as.data.frame() %>% 
  rownames_to_column(., var = "name") %>% 
  as_tibble() %>% 
  separate(name, c("param", "trt", "ED"), sep = ":") %>% 
  janitor::clean_names() %>% 
  separate("trt", c("location", "crop"), sep = "-", remove = FALSE) %>% 
  mutate(location = str_to_title(location)) %>% 
  mutate_if(is_character, as_factor) -> ed3
```

```{r}
EDcomp(model3, c(90,90), type = "absolute", 
       interval = "delta", multcomp = FALSE)
```


```{r}
ed3 %>% 
  mutate(ed = case_when(
  ed == "10" ~ "10% emergence",
  ed == "50" ~ "50% emergence",
  ed == "90" ~ "90% emergence",
  TRUE ~ "ed")) %>% 
  ggplot(aes(x = location, y = estimate, color = crop)) +
  geom_point(position = position_dodge(width = 0.7)) +
  geom_linerange(aes(ymin = lower, ymax = upper), 
                 position = position_dodge(width = 0.7)) +
  labs(x = NULL, y = "Growing degree days",
       title = "Horseweed emergence in <b style='color:#b02631;'>wheat stubble</b> and <b style='color:#0000ff;'>soybean</b> at Nebraska",
       subtitle = "Horseweed comulative emergence was recorded from Sep 2016 to May 2017. Horseweed emergence was nearly half in Scotssbluff (wheat stubble and soybean) and Lincoln (oybean)") +
  scale_color_manual(values = c("#b02631", "#0000ff")) +
  facet_grid(~ ed) +
  coord_flip() +
  theme_few() +
  scale_y_continuous(limits = c(0, 1500)) +
  theme(legend.position = "none",
        plot.title.position = "plot",
        plot.title = element_markdown(),
        plot.subtitle = element_markdown(size = 10)) 

ggsave("figures/fig_3.png", dpi = 300)
```

```{r}

ggplot()
```


